const PosixMQ = require('./lib/index');
const mq = new PosixMQ();

// Open the queue and allocate the buffer to read messages into
mq.open({name: '/pmqtest'});
readbuf = Buffer.alloc(mq.msgsize);

// Define the handler function to read all messages currently in the queue
handleMsg = () => {
    let n;
    while ((n = mq.shift(readbuf)) !== false) {
        let msg = readbuf.toString('utf8', 0, n);
        console.log("Received message("+ n +" bytes): " + msg);
        console.log("Messages left: "+ mq.curmsgs);
    }
};

// Call the handler function once before binding the handler to ensure
// all existing messages are read
handleMsg();

// Bind the handler now that the queue has been emptied by the previous invocation
mq.on('messages', handleMsg);
